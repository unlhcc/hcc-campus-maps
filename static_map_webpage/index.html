<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoJSON Map Viewer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div class="controls">
      <button id="streetsBtn" class="active">Streets</button>
      <button id="satelliteBtn">Satellite</button>
      <button id="topoBtn">Topographic</button>
    </div>

    <div id="map"></div>

    <div class="info" id="info">Loading GeoJSON data...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>

    <script>
      let map;
      let geoJsonLayer;
      const GEOJSON_URL = "buildings_using_hcc.geojson";

      // Define base layers
      const baseLayers = {
        streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
          maxZoom: 19
        }),
        topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
          maxZoom: 17
        })
      };

      function initMap() {
        // Initialize map centered on University of Nebraska - Lincoln
        map = L.map('map', {
          center: [40.8202, -96.7006],
          zoom: 16,
          layers: [baseLayers.streets]
        });

        // Load GeoJSON data
        loadGeoJSON();

        // Setup map type controls
        setupControls();

        // Auto-refresh every 6 hours (21600000 ms)
        setInterval(loadGeoJSON, 21600000);
      }

      function loadGeoJSON() {
        const timestamp = new Date().getTime();
        fetch(`${GEOJSON_URL}?t=${timestamp}`) // Cache busting
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            // Remove existing GeoJSON layer if it exists
            if (geoJsonLayer) {
              map.removeLayer(geoJsonLayer);
            }

            // Add new GeoJSON layer with styling
            geoJsonLayer = L.geoJSON(data, {
              style: function(feature) {
                const usesHcc = feature.properties.departments.length > 0;
                let fillColor, color, fillOpacity;
                if (usesHcc) {
                  fillColor = "#FF0000";
                  fillOpacity = 0.8;
                  color = "#CC0000";
                } else {
                  fillColor = "#808080";
                  fillOpacity = 0.4;
                  color = "#606060";
                }
                return {
                  fillColor: fillColor,
                  fillOpacity: fillOpacity,
                  color: color,
                  weight: 2
                };
              },
              onEachFeature: function(feature, layer) {
                // Create popup content
                let content = '<div style="padding: 10px;">';
                content += "<strong>Feature Properties:</strong><br>";

                if (feature.properties) {
                  useful_properties = ["name", "abbrev", "departments"];
                  for (let key in useful_properties) {
                    content += `${key}: ${feature.properties[key]}<br>`;
                  }
                }

                content += "</div>";

                layer.bindPopup(content);
              }
            }).addTo(map);

            // Update info
            const featureCount = data.features ? data.features.length : 0;
            const lastUpdate = new Date().toLocaleString();
            document.getElementById(
              "info"
            ).innerHTML = `Features: ${featureCount} | Last updated: ${lastUpdate}`;

            // Auto-zoom to fit all features
            if (geoJsonLayer.getBounds().isValid()) {
              map.fitBounds(geoJsonLayer.getBounds());
            }
          })
          .catch((error) => {
            console.error("Error loading GeoJSON:", error);
            document.getElementById(
              "info"
            ).innerHTML = `Error loading data: ${error.message}`;
          });
      }

      function setupControls() {
        document
          .getElementById("streetsBtn")
          .addEventListener("click", function () {
            map.removeLayer(baseLayers.satellite);
            map.removeLayer(baseLayers.topo);
            map.addLayer(baseLayers.streets);
            updateActiveButton(this);
          });

        document
          .getElementById("satelliteBtn")
          .addEventListener("click", function () {
            map.removeLayer(baseLayers.streets);
            map.removeLayer(baseLayers.topo);
            map.addLayer(baseLayers.satellite);
            updateActiveButton(this);
          });

        document
          .getElementById("topoBtn")
          .addEventListener("click", function () {
            map.removeLayer(baseLayers.streets);
            map.removeLayer(baseLayers.satellite);
            map.addLayer(baseLayers.topo);
            updateActiveButton(this);
          });
      }

      function updateActiveButton(activeBtn) {
        document.querySelectorAll(".controls button").forEach((btn) => {
          btn.classList.remove("active");
        });
        activeBtn.classList.add("active");
      }

      // Initialize map when page loads
      initMap();
    </script>
  </body>
</html>